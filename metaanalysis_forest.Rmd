---
title: "Metaanalysis"
output: html_document
---


```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(meta)
library(gridGraphics)
library(gridExtra)
library(ggpubr)
library(gridExtra)
library(tidyverse)
library(patchwork)
library(stringr)
#library(devtools)
#devtools::install_github("rdboyes/forester")
#library(forester)
source("R/forester_custom.R")
```

```{r}
rdas <- list.files(
  path = "results",
  pattern = ".rda",
  full.names = TRUE
)
for (rda in rdas) {
  load(rda)
}

site_results <- mget(ls(pattern = "result"))
```

## Conduct Random-Effects Meta-Analysis

Here we conduct meta-analysis on outcomes occurring within the first hospital stay.

**Note: Can run meta-analysis on effects of specific neuro_post type by setting changing ```neuro_chr``` in the get_result_row to ```neuro_postCentral```, ```neuro_postPeripheral``` or ```neuro_postBoth```**

```{r}
get_site <- function(x){
  x$site
}



get_result_row <- function(df,
                           outcome = 'n_stay_reg_elix',
                           period = 'first_hosp_results',
                           neuro_type = 'cpns_results',
                           neuro_chr = 'neuro_postCentral') {
  # neuro_chr <- switch(neuro_type,
  #   cpns_results = 'neuro_postPeripheral',
  #   binary_results = 'neuro_postneuro_cond'
  # )
  df[[c(period, neuro_type, outcome, 'coefficients')]] %>%
    as.data.frame() %>%
    rownames_to_column('term') %>%
    mutate(site = get_site(df)) %>%
    filter(grepl(neuro_chr, term))
}

outcomes <-
  c(
    "n_stay_reg_elix",
    "severe_reg_elix",
    "deceased_reg_elix",
    "n_readmit_reg_elix",
    "readmit_reg_elix",
    "time_severe_reg_elix",
    "time_deceased_reg_elix",
    "time_readmit_reg_elix" 
  )

meta_results <- list()
for (outcome_i in outcomes) {
  meta_results[[outcome_i]] <-
    site_results %>% 
    lapply(get_result_row, outcome = outcome_i) %>%
    bind_rows() %>%
    metagen(
      Estimate,
      `Std. Error`,
      data = .,
      sm = 'MD',
      comb.random = TRUE,
      comb.fixed = FALSE,
      method.tau = "DL", # default tau method
      hakn = FALSE,
      prediction=TRUE,
      studlab = site
      
    )
}
```

```{r}
ma_combine = list()

for (i in names(meta_results)) {
  TE = meta_results[[i]][["TE"]]
  studlab = meta_results[[i]][["studlab"]]
  upper = meta_results[[i]][["upper"]]
  lower = meta_results[[i]][["lower"]]
  TE.random = meta_results[[i]][["TE.random"]]
  lower.random = meta_results[[i]][["lower.random"]]
  upper.random = meta_results[[i]][["upper.random"]]
  pval.random = meta_results[[i]][["pval.random"]]
  Weight.random = meta_results[[i]][["w.random"]]
  lower.predict = meta_results[[i]][["lower.predict"]]
  upper.predict = meta_results[[i]][["upper.predict"]]
  I2 = meta_results[[i]][["I2"]]
  lower.I2 = meta_results[[i]][["lower.I2"]]
  upper.I2 = meta_results[[i]][["upper.I2"]]
  H = meta_results[[i]][["H"]]
  lower.H = meta_results[[i]][["H"]]
  upper.H = meta_results[[i]][["upper.H"]]
  tau2 = meta_results[[i]][["tau2"]]
  lower.tau2 = meta_results[[i]][["lower.tau2"]]
  upper.tau2 = meta_results[[i]][["upper.tau2"]]
  analysis = paste(i)
  df <- cbind(analysis, studlab, TE, upper, lower, TE.random, lower.random, upper.random, Weight.random,
              pval.random, lower.predict, upper.predict, I2, lower.I2, upper.I2, H, lower.H, upper.H, 
              tau2, lower.tau2, upper.tau2)
  ma_combine[[i]] <- df
}

combined_results <- do.call(rbind.data.frame, ma_combine)

combined_results <- combined_results %>%
  mutate_at(vars(TE:upper.tau2), ~ as.character(.) %>% as.numeric()) %>% 
  mutate_at(vars(TE:upper.tau2, -pval.random), ~ round(., 2)) %>%
  mutate(CI.random = paste("(", lower.random, ",", upper.random, ")")) %>%
  rename("Site" = studlab, 
         "Estimate" = TE, 
         "p-value" = pval.random,
         "CI.High" = upper,
         "CI.Low" = lower,
         "CI" = CI.random)
                                                

# Record analysis name to look nicer
combined_results$analysis <- recode(combined_results$analysis,
                                    'n_stay_reg_elix' = 'Length of Stay',
                                    'severe_reg_elix' = 'Severe COVID-19',
                                    'deceased_reg_elix' = 'Mortality',
                                    'n_readmit_reg_elix' = 'Number of Readmissions',
                                    'readmit_reg_elix' = 'Readmission',
                                    'time_severe_reg_elix' = 'Time to Severity',
                                    'time_deceased_reg_elix' = 'Time to Mortality',
                                    'time_readmit_reg_elix' = 'Time to Readmission')
```

Add blank rows to facilitate formatting

```{r}
df_new <- as.data.frame(lapply(combined_results, as.character), stringsAsFactors = FALSE)
# add two blank rows
combined_results <- head(do.call(rbind, by(df_new, combined_results$analysis, rbind, "", "")), -1)

# add row to top row
combined_results <- combined_results %>% 
  add_row(.before = 1) %>%
  add_row(.before = 1)

# remove last row
combined_results <- combined_results %>% 
  head(-1)

# convert NA to blank rows
combined_results[is.na(combined_results)] <- ""
```

Carry over name of the analysis to the blank row

```{r}
# first convert blank spaces to NA
combined_results[combined_results == ""] <- NA

# Add the analysis labels to the original site level rows - these will be our labels for the forest plots
combined_results <- combined_results %>% 
  fill(analysis, .direction = "up") %>%
  mutate(id = seq_len(nrow(.)),
         Site = if_else(is.na(Site), analysis, Site),
         lag_Site = lag(Site),
         lag_Site = if_else(is.na(lag_Site), "First", lag_Site),
         Site = ifelse(Site == lag_Site, paste(Site, "_", id), Site)) %>% 
  select(-analysis, -lag_Site, -id) %>%
  rename("Analysis" = Site) 
```

Indent site results

```{r}
# convert columns back to numeric
combined_results <- combined_results %>%
  mutate_at(vars(Estimate:upper.tau2), ~ as.character(.) %>% as.numeric())

combined_results$Analysis <- ifelse(is.na(combined_results$Estimate),
                         combined_results$Analysis,
                         paste0("   ", combined_results$Analysis))
```

Change row names to make it easier to subset the data by analysis for the forest plots

```{r}
rownames(combined_results) <- ifelse(is.na(combined_results$Estimate),
                                     paste(combined_results$Analysis),
                                     rownames(combined_results))

# make the secondary analysis label blank
combined_results <- combined_results %>%
  mutate(Analysis = ifelse(grepl("_", Analysis), NA, Analysis))
```

Additional formatting to integrate the random-effects meta analysis results with the regression estimates

```{r}
# select the variables representing results from the overall meta-analysis 
overall_results <- c("TE.random", "upper.random", "lower.random", "p.value", "CI", 
       "lower.predict", 'upper.predict', 'I2', 'lower.I2', 'upper.I2', 'H', 
       'lower.H', 'upper.H', 'tau2', 'lower.tau2', 'upper.tau2')

# fill these columns up to the first overall meta-analysis results row where there are currently NAs
combined_results <- combined_results %>%
  fill(overall_results, .direction = "up")

# subsequently, make the site level information NA for the following columns
combined_results <- combined_results %>% 
  mutate_at(vars(overall_results), ~ ifelse(is.na(Estimate), .x, NA))

# move meta analysis results to the same columns as the site regression estimates 
combined_results$Estimate <- ifelse(is.na(combined_results$Estimate), combined_results$TE.random, combined_results$Estimate)
combined_results$CI.High <- ifelse(is.na(combined_results$CI.High), combined_results$upper.random, combined_results$CI.High)
combined_results$CI.Low <- ifelse(is.na(combined_results$CI.Low), combined_results$lower.random, combined_results$CI.Low)

# create new 'Estimate' column that we can append CIs 
# format the p-values so we don't lose trailing zeros which occurs with as.character()
# the below steps seem long but best way as of now to ensure that we can add < signs and astericks when dealing with numeric and character data 
combined_results <- combined_results %>% 
  mutate('Estimate ' = paste(Estimate, "(", CI.Low, ",", CI.High, ")"),
         p.value_round = round(p.value, 5),
         sig = if_else(p.value < 0.05, 1, 0),
         p.value_format = ifelse(p.value_round < 0.00001, "< 0.00001", p.value_round),
         p.value_format2 = sprintf("%.5f", p.value),
         p.value_format = ifelse(p.value_format == "< 0.00001", p.value_format, p.value_format2),
         `P-value` = if_else(sig == 1, paste(p.value_format, "*"), p.value_format)) %>%
  select(-p.value_round, -p.value_format, -p.value_format2, -sig)


combined_results$p.value[combined_results$p.value == "NA"] <- ""
combined_results[is.na(combined_results)] <- ""

# make sure the row of the second analysis label is blank
cols <- colnames(combined_results)

combined_results[ ,cols] <- as.data.frame(lapply(cols, 
              FUN = function(x) ifelse(combined_results$Analysis == "", "", combined_results[, x])))


# convert back to numeric
# make the secondary analysis label blank
combined_results <- combined_results %>% 
  mutate_at(vars(overall_results, Estimate, Weight.random, CI.High, CI.Low), ~ as.character(.) %>% as.numeric()) %>%
  mutate(Analysis = as.character(Analysis),
         Analysis = ifelse(is.na(Estimate), "Site", Analysis)) %>%
  select(-TE.random, -lower.random, -upper.random)
```

### Clean up results dataframe

```{r eval=FALSE, include=FALSE}
results_table <- combined_results %>% 
  select(Analysis, `Estimate `, Weight.random, p.value,
         lower.predict, upper.predict,
         I2, lower.I2, upper.I2,
         H, lower.H, upper.H,
         tau2, lower.tau2, upper.tau2) %>% 
  mutate(Predict.CI = paste("(", lower.predict, ",", upper.predict, ")"),
         I2.CI = paste("(", lower.I2, ",", upper.I2, ")"),
         H.CI = paste("(", lower.H, ",", upper.H, ")"),
         tau2.CI = paste("(", lower.tau2, ",", upper.tau2, ")")) %>%
  select(-lower.predict, -upper.predict, -lower.I2, -upper.I2, -lower.H, -upper.H, -lower.tau2, -upper.tau2, 
         Analysis, `Estimate `, Weight.random, p.value, Predict.CI, I2, I2.CI, H, H.CI, tau2, tau2.CI)

results_table[results_table == "( NA , NA )"] <- ""
results_table[is.na(results_table)] <- ""


write.csv(results_table, file = paste0("meta_tables/meta_tables", meta_results[["n_stay_reg_elix"]][["data"]][["term"]][[1]], ".csv"), 
          row.names = FALSE, )
```


## Results

### Length of Stay

```{r fig.width=8, message=FALSE, warning=FALSE}
length_stay_results <- combined_results %>% 
  slice(grep(paste("Length of Stay", collapse="|"), row.names(.)))

## define forest plot shapes
# shape #16 is normal circle; #18 is diamond
shapes <- rep(16, times = nrow(length_stay_results))
shapes[1] <- 18

sizes <- rep(3.25, times = nrow(length_stay_results))
sizes[1] <- 5

# point_colors <- rep("black", times = nrow(length_stay_results))
# point_colors[1] <- "blue"


forester(left_side_data = length_stay_results[1],
         estimate = length_stay_results$Estimate,
         ci_low = length_stay_results$CI.Low,
         ci_high = length_stay_results$CI.High,
         right_side_data = length_stay_results[,c("Estimate ", "P-value")],
         display = TRUE,
         font_family = "arial",
         arrows = TRUE, 
         arrow_labels = c("Decreased Length", "Increased Length of Stay"),
         xlim = c(-1,22),
         xbreaks = c(-1, 0, 30),
         point_sizes = sizes,
         point_shapes = shapes,
         file_path = here::here("figures/Forest_plot_length_of_stay.png"))
```

### Readmission

```{r fig.width=8, message=FALSE, warning=FALSE}
readmit_results <- combined_results %>% 
  slice(grep(paste("Readmission", collapse="|"), row.names(.))) %>% 
  filter(!grepl('Number|Time', row.names(.)))

shapes <- rep(16, times = nrow(readmit_results))
shapes[1] <- 18

sizes <- rep(3.25, times = nrow(readmit_results))
sizes[1] <- 5

forester(left_side_data = readmit_results[1],
         estimate = readmit_results$Estimate,
         ci_low = readmit_results$CI.Low,
         ci_high = readmit_results$CI.High,
         right_side_data = readmit_results[,c("Estimate ", "P-value")],
         display = TRUE,
         font_family = "arial",
         arrows = TRUE, 
         arrow_labels = c("Decreased Risk", "Increased Risk"),
         xlim = c(-1,1),
         xbreaks = c(-1, 0, 1),
         point_sizes = sizes,
         point_shapes = shapes,
         file_path = here::here("figures/Forest_plot_readmission.png"))
```


### Severe COVID-19 

```{r fig.width=8, message=FALSE, warning=FALSE}
severe_results <- combined_results %>% 
  slice(grep(paste("Severe", collapse="|"), row.names(.))) %>% 
  filter(!grepl('Time', row.names(.)))

shapes <- rep(16, times = nrow(severe_results))
shapes[1] <- 18

sizes <- rep(3.25, times = nrow(severe_results))
sizes[1] <- 5

forester(left_side_data = severe_results[1],
         estimate = severe_results$Estimate,
         ci_low = severe_results$CI.Low,
         ci_high = severe_results$CI.High,
         right_side_data = severe_results[,c("Estimate ", "P-value")],
         display = TRUE,
         font_family = "arial",
         arrows = TRUE, 
         arrow_labels = c("Decreased Risk", "Increased Risk"),
         xlim = c(-1,3),
         xbreaks = c(-1, 0, 3),
         point_sizes = sizes,
         point_shapes = shapes,
         file_path = here::here("figures/Forest_plot_severe.png"))
```

### Mortality

```{r fig.width=8, message=FALSE, warning=FALSE}
death_results <- combined_results %>% 
  slice(grep(paste("Mortality", collapse="|"), row.names(.))) %>% 
  filter(!grepl('Time', row.names(.)))

shapes <- rep(16, times = nrow(death_results))
shapes[1] <- 18

sizes <- rep(3.25, times = nrow(death_results))
sizes[1] <- 5

forester(left_side_data = death_results[1],
         estimate = death_results$Estimate,
         ci_low = death_results$CI.Low,
         ci_high = death_results$CI.High,
         right_side_data = death_results[,c("Estimate ", "P-value")],
         display = TRUE,
         font_family = "arial",
         arrows = TRUE, 
         arrow_labels = c("Decreased Risk", "Increased Risk"),
         xlim = c(-1,2),
         xbreaks = c(-1, 0, 2),
         point_sizes = sizes,
         point_shapes = shapes,
         file_path = here::here("figures/Forest_plot_death.png"))
```

### Time to Severity

```{r fig.width=8, message=FALSE, warning=FALSE}
severe_time_results <- combined_results %>% 
  slice(grep(paste("Time to Severity", collapse="|"), row.names(.)))

shapes <- rep(16, times = nrow(severe_time_results))
shapes[1] <- 18

sizes <- rep(3.25, times = nrow(severe_time_results))
sizes[1] <- 5

forester(left_side_data = severe_time_results[1],
         estimate = severe_time_results$Estimate,
         ci_low = severe_time_results$CI.Low,
         ci_high = severe_time_results$CI.High,
         right_side_data = severe_time_results[,c("Estimate ", "P-value")],
         display = TRUE,
         font_family = "arial",
         arrows = TRUE, 
         arrow_labels = c("Decreased Time", "Increased Time"),
         xlim = c(-12.5,5.5),
         xbreaks = c(-12.5, 0, 5.5),
         point_sizes = sizes,
         point_shapes = shapes,
         file_path = here::here("figures/Forest_plot_severe_time.png"))
```

### Time to Death

```{r fig.width=8, message=FALSE, warning=FALSE}
death_time_results <- combined_results %>% 
  slice(grep(paste("Time to Mortality", collapse="|"), row.names(.)))

shapes <- rep(16, times = nrow(death_time_results))
shapes[1] <- 18

sizes <- rep(3.25, times = nrow(death_time_results))
sizes[1] <- 5

forester(left_side_data = death_time_results[1],
         estimate = death_time_results$Estimate,
         ci_low = death_time_results$CI.Low,
         ci_high = death_time_results$CI.High,
         right_side_data = death_time_results[,c("Estimate ", "P-value")],
         display = TRUE,
         font_family = "arial",
         arrows = TRUE, 
         arrow_labels = c("Decreased Risk", "Increased Risk"),
         xlim = c(-17,17),
         xbreaks = c(-17, 0, 17),
         point_sizes = sizes,
         point_shapes = shapes,
         file_path = here::here("figures/Forest_plot_death_time.png"))
```


### Time to Readmission

```{r fig.width=8, message=FALSE, warning=FALSE}
readmit_time_results <- combined_results %>% 
  slice(grep(paste("Time to Readmission", collapse="|"), row.names(.)))

shapes <- rep(16, times = nrow(readmit_time_results))
shapes[1] <- 18

sizes <- rep(3.25, times = nrow(readmit_time_results))
sizes[1] <- 5

forester(left_side_data = readmit_time_results[1],
         estimate = readmit_time_results$Estimate,
         ci_low = readmit_time_results$CI.Low,
         ci_high = readmit_time_results$CI.High,
         right_side_data = readmit_time_results[,c("Estimate ", "P-value")],
         display = TRUE,
         font_family = "arial",
         arrows = TRUE, 
         arrow_labels = c("Decreased Time", "Increased Time"),
         xlim = c(-85,75),
         xbreaks = c(-85, 0, 75),
         point_sizes = sizes,
         point_shapes = shapes,
         file_path = here::here("figures/Forest_plot_readmission_time.png"))
```

### Number of Readmissions

```{r fig.width=8, message=FALSE, warning=FALSE}
readmit_n_results <- combined_results %>% 
  slice(grep(paste("Number of Readmissions", collapse="|"), row.names(.)))

shapes <- rep(16, times = nrow(readmit_n_results))
shapes[1] <- 18

sizes <- rep(3.25, times = nrow(readmit_n_results))
sizes[1] <- 5

forester(left_side_data = readmit_n_results[1],
         estimate = readmit_n_results$Estimate,
         ci_low = readmit_n_results$CI.Low,
         ci_high = readmit_n_results$CI.High,
         right_side_data = readmit_n_results[,c("Estimate ", "P-value")],
         display = TRUE,
         font_family = "arial",
         arrows = TRUE, 
         arrow_labels = c("Decreased Readmissions", "Increased Readmissions"),
         xlim = c(-1,1.5),
         xbreaks = c(-1, 0, 1.5),
         point_sizes = sizes,
         point_shapes = shapes,
         file_path = here::here("figures/Forest_plot_readmission_n.png"))
```


