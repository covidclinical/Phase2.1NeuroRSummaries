---
title: "Demo Figure"
author: "Meg Hutch"
date: "3/22/2021"
output: html_document
---

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(gridGraphics)
library(gridExtra)
library(ggpubr)
library(DT)
library(kableExtra)
library(cowplot)
theme_set(theme_bw() +
            theme(panel.grid.minor = element_blank()))
```

```{r}
rdas <- list.files(path = 'results',
                   pattern = '.rda',
                   full.names = TRUE)
for (rda in rdas)
  load(rda)

rm(rdas, rda)
results <- ls()

sites_wo_race <- c('APHP', 'FRBDX', 'ICSM', 'HPG23')
```

## Demographic Data

### Pre-processing

```{r}
demo_table_list <- list()

for (i in results) { 
  tmp <- get(i)
  demo_table <- tmp[["first_hosp_results"]][["cpns_results"]][["demo_table"]]
  demo_table <- as.data.frame(demo_table)
  demo_table <- demo_table %>% select(site, everything())
  demo_table_list[[i]] <- demo_table
}
combined_table <- do.call(bind_rows, demo_table_list) %>% 
  mutate(site = toupper(site))

# site level differences in variable names require tolower()
combined_table <- combined_table %>%
  mutate(variable = tolower(variable)) 

# heatmap(UPITT_results$elix_mat)
```

## Table One

```{r}
## Add total Patients
n <- combined_table %>% 
  filter(variable == "sex.female" | variable == "sex.male") %>%
  select(variable, n_var_None, n_var_Peripheral, n_var_Central, n_var_Both)

n_all <-  n %>% 
  select(-variable) %>% 
  colSums(na.rm = TRUE)  %>%
  t() %>%
  as.data.frame() %>%
  mutate(variable = "All Patients")

## Gender
n_female <- n %>% 
  filter(variable == "sex.female") %>% 
  select(-variable) %>% 
  colSums(na.rm = TRUE)  %>%
  t() %>%
  as.data.frame() %>%
  mutate(variable = "female")

n_male <- n %>% 
  filter(variable == "sex.male") %>% 
  select(-variable) %>% 
  colSums(na.rm = TRUE) %>% 
  t() %>%
  as.data.frame() %>%
  mutate(variable = "male")

## Age
age_vars <- combined_table %>% 
  filter(stringr::str_detect(variable, 'age')) %>%
  distinct(variable) %>%
  arrange(variable)

age_sums_list <- list()

for (i in age_vars$variable) {
  table_age_sums <- combined_table %>%
    filter(variable == paste(i)) %>%
    select(n_var_None, n_var_Peripheral, n_var_Central, n_var_Both) %>%
    colSums(na.rm = TRUE) %>%
    t() %>%
    as.data.frame() %>%
    mutate(variable = paste(i))
  age_sums_list[[i]] <- table_age_sums
}
n_age <- do.call(rbind.data.frame, age_sums_list)

## Race
race_vars <- combined_table %>% 
  filter(stringr::str_detect(variable, 'race')) %>%
  arrange(site) %>%
  distinct(variable) 

race_sums_list <- list()

for (i in race_vars$variable) {
  table_race_sums <- combined_table %>%
    filter(variable == paste(i)) %>%
    select(n_var_None, n_var_Peripheral, n_var_Central, n_var_Both) %>%
    colSums(na.rm = TRUE) %>%
    t() %>%
    as.data.frame() %>%
    mutate(variable = paste(i))
  race_sums_list[[i]] <- table_race_sums
}
n_race <- do.call(rbind.data.frame, race_sums_list)

## Readmitted
readmit_vars <- combined_table %>% 
  filter(stringr::str_detect(variable, 'readmitted')) %>%
  distinct(variable) 

readmit_sums_list <- list()

for (i in readmit_vars$variable) {
  table_readmit_sums <- combined_table %>%
    filter(variable == paste(i)) %>%
    select(n_var_None, n_var_Peripheral, n_var_Central, n_var_Both) %>%
    colSums(na.rm = TRUE) %>%
    t() %>%
    as.data.frame() %>%
    mutate(variable = paste(i))
  readmit_sums_list[[i]] <- table_readmit_sums
}
n_readmit <- do.call(rbind.data.frame, readmit_sums_list)

## Death
death_vars <- combined_table %>% 
  filter(stringr::str_detect(variable, 'survival')) %>%
  distinct(variable) 

death_sums_list <- list()

for (i in death_vars$variable) {
  table_death_sums <- combined_table %>%
    filter(variable == paste(i)) %>%
    select(n_var_None, n_var_Peripheral, n_var_Central, n_var_Both) %>%
    colSums(na.rm = TRUE)  %>%
    t() %>%
    as.data.frame() %>%
    mutate(variable = paste(i))
  death_sums_list[[i]] <- table_death_sums
}
n_death <- do.call(rbind.data.frame, death_sums_list)

tableOne_compiled <- rbind(n_all, 
                           n_female, 
                           n_male,
                           n_age,
                           n_race,
                           n_readmit,
                           n_death) %>%
  rename("Table 1" = variable,
         "None" = n_var_None,
         "PNS" = n_var_Peripheral,
         "CNS" = n_var_Central,
         "Both" = n_var_Both)

dx_vars = c("None", "PNS", "CNS", "Both")
n_list = list()
for(i in (dx_vars)) {
  n_sample <- tableOne_compiled %>%
  filter(`Table 1` == "All Patients") %>%
  select(i)
  n_list[[i]] <- n_sample
}
n_list <- do.call(cbind.data.frame, n_list)

tableOne_compiled <- tableOne_compiled %>%
  mutate(N = rowSums(across(where(is.numeric))),
         None_perc = round(None/n_list$None*100, 1),
         PNS_perc = round(PNS/n_list$PNS*100, 1),
         CNS_perc = round(CNS/n_list$CNS*100, 1),
         Both_perc = round(Both/n_list$Both*100, 1),
         None = paste(None, "(", None_perc, "%", ")"),
         PNS = paste(PNS, "(", PNS_perc, "%", ")"),
         CNS = paste(CNS, "(", CNS_perc, "%", ")"),
         Both = paste(Both, "(", Both_perc, "%", ")")) %>%
  select(`Table 1`, N, None, CNS, PNS, Both, -None_perc, -PNS_perc, -CNS_perc, -Both_perc) 

rownames(tableOne_compiled) <- NULL

# recode names of variables
tableOne_compiled$`Table 1` <-  recode(tableOne_compiled$`Table 1`,
                                         female = "Female",
                                         male = "Male",
                                         age_group.00to02  = "0-2",
                                         age_group.03to05 = "3-5",
                                         age_group.06to11 = "6-11",
                                         age_group.12to17 = "12-17",
                                         age_group.18to25 = "18-25",
                                         age_group.26to49 = "26-49",
                                         age_group.50to69 = "50-69",
                                         age_group.70to79 = "70-79",
                                         age_group.80plus = "80+",
                                         race.white = "White",
                                         race.american_indian = "American Indian",
                                         race.asian = "Asian",
                                         race.black = "Black",
                                         race.hawaiian_pacific_islander = "Hawaiian/Pacific Islander",
                                         race.hispanic_latino = "Hispanic/Latino",
                                         race.other = "Other",
                                         readmitted.false = "Not Readmitted",
                                         readmitted.true = "Readmitted",
                                         survival.alive = "Alive",
                                         survival.deceased = "Deceased")


kbl(tableOne_compiled) %>%
  add_header_above(c(" ", "", "No Neurological Disease" = 1, "Neurological Disease" = 3)) %>%
  kable_paper("striped", full_width = F) %>%
  pack_rows("Age", 4, 12) %>%
  pack_rows("Race & Ethnicty", 13, 19) %>%
  pack_rows("Readmission", 20, 21) %>%
  pack_rows("Deceased", 22, 23)

```

```{r fig.height=15, fig.width=11}
combined_table <- combined_table %>%
    mutate(Demo_var = sub("\\..*", "", variable),
           Demo_var_i = sub(".*\\.", "", variable)) %>%
  pivot_longer(cols = c(n_var_None:n_var_Both),
               names_to = "Dx",
               values_to = "Count") %>% 
  replace_na(list(Count = 0))

combined_table$Dx <- recode(combined_table$Dx,
                            n_var_Both = "Both",
                            n_var_Central = "CNS",
                            n_var_Peripheral = "PNS",
                            n_var_None = "None")

combined_table$Dx <- fct_relevel(combined_table$Dx, 
                                         c('None', 'CNS', 'PNS', "Both"))
```

```{r}
combined_table$Demo_var_i <-  recode(combined_table$Demo_var_i,
                                     female = "Female",
                                     male = "Male",
                                     `00to02`  = "0-2",
                                     `03to05` = "3-5",
                                     `06to11` = "6-11",
                                     `12to17` = "12-17",
                                     `18to25` = "18-25",
                                     `26to49` = "26-49",
                                     `50to69` = "50-69",
                                     `70to79` = "70-79",
                                     `80plus` = "80+",
                                     white = "White",
                                     american_indian = "American Indian",
                                     asian = "Asian",
                                     black = "Black",
                                     hawaiian_pacific_islander = "Hawaiian/Pacific Islander",
                                     hispanic_latino = "Hispanic/Latino",
                                     other = "Other",
                                     false = "Not Readmitted",
                                     true = "Readmitted",
                                     alive = "Alive",
                                     deceased = "Deceased",
                                     `non-severe` = "Non-Severe",
                                     severe = 'Severe')
```

## Figures

```{r echo=T, message=FALSE, warning=FALSE, results='hide'}
race_dx <- combined_table %>% 
  filter(Demo_var == "race") %>%
  mutate(Demo_var_i = as.factor(Demo_var_i))

age_dx <- combined_table %>% 
  filter(Demo_var == "age_group") %>%
  mutate(Demo_var_i = as.factor(Demo_var_i))

```


```{r gender-plot} 
sorted_sites <- rev(c("APHP", "FRBDX", "ICSM", "NWU", "UPENN", "UPITT"))
colorBlindGrey6 <- c("#0072B2", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#CC79A7")

showtext::showtext_auto()
female <- intToUtf8(9792)
male <- intToUtf8(9794)
gender_count <- combined_table %>%
  filter(Demo_var == "sex") %>% 
  group_by(site, Demo_var_i) %>% 
  summarise(total_count = sum(Count, na.rm = TRUE), .groups = 'drop')

gender_plot <- gender_count %>% 
  mutate(total_count = if_else(Demo_var_i == 'Male', - total_count, total_count)) %>%
  ggplot(aes(y = fct_relevel(site, sorted_sites), 
             x = total_count, color = Demo_var_i)) +
  geom_col(position = 'identity', fill = 'grey70') +
  scale_color_manual(values = c('white', 'white')) +
  scale_x_continuous(breaks = c(-10000, -5000, -2000, 0, 2000, 5000),
                     labels = c(10000, 5000, 2000, 0, 2000, 5000),
                     trans = ggallin::ssqrt_trans) +
  geom_vline(xintercept = 0, color = 'white') +
  geom_text(data = . %>% filter(Demo_var_i == 'Male'),
            aes(y = site, x = total_count - 22*sqrt(abs(total_count)),
                label = abs(total_count)), color = 'grey10', size = 3) +
    geom_text(data = . %>% filter(Demo_var_i == 'Female'),
            aes(y = site, x = total_count + 19*sqrt(abs(total_count)),
                label = abs(total_count)), color = 'grey10', size = 3) +
  geom_text(data = . %>% filter(site == 'APHP', Demo_var_i == 'Female'),
            aes(y = length(sorted_sites), x = total_count - 600), fontface = 2,
            label = female, size = 3, color = 'white') +
  geom_text(data = . %>% filter(site == 'APHP', Demo_var_i == 'Male'),
            aes(y = length(sorted_sites), x = total_count + 600), fontface = 2,
            label = male, size = 3, color = 'white') +
  labs(y = NULL, 
       x = 'Number of male/female patients per site', 
       fill = NULL) +
  theme(legend.position = 'None',
        # plot.margin = margin(15, 5.5, 15.5, 55.5),
        axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.spacing.y = unit(0, 'pt'),
        strip.background = element_blank(),
        strip.placement = 'inside',
        legend.background = element_blank(),
        legend.key.height = unit(1, 'line'),
        legend.title = element_text(hjust = 0, size = 9)) +
  NULL
```

```{r age-plot}
age_sum <- age_dx %>%
  filter(Demo_var == "age_group") %>%
  mutate(Demo_var_i = fct_relevel(
    Demo_var_i,
    c(
      "0-2",
      "3-5",
      "6-11",
      "12-17",
      "18-25",
      "26-49",
      "50-69",
      "70-79",
      "80+"
    )
  )) %>%
  select(site, Demo_var_i, Dx, Count) %>%
  distinct() %>%
  group_by(site, Demo_var_i) %>%
  summarise(total_count = sum(Count, na.rm = TRUE),
            .groups = 'drop') %>%
  group_by(site) %>%
  mutate(freq = total_count / sum(total_count, na.rm = TRUE))

cc <- scales::seq_gradient_pal("white", "#25796C")(seq(0,1,length.out = 10))[-1]

age_plot <- age_sum %>% 
 ggplot(aes(y = fct_relevel(site, sorted_sites), 
            x = freq, fill = fct_rev(Demo_var_i))) + 
  geom_col() +
  # scale_fill_viridis_d(direction = -1, option = 'D') + 
  scale_fill_manual(values = cc) +
  scale_x_continuous(labels = scales::percent_format()) +
  labs(x = 'Age group proportion', y = NULL, fill = NULL) +
  guides(fill = guide_legend(nrow = 1, reverse = TRUE)) +
  coord_cartesian(expand = FALSE) +
  theme(legend.position = "top") +
  theme(panel.grid = element_blank(),
        legend.key.height = unit(3, 'mm')) +
  NULL
```


```{r race-plot}
race_sum <- race_dx %>%
  mutate(Demo_var_i = fct_relevel(
    Demo_var_i,
    c(
      "Hawaiian/Pacific Islander",
      "American Indian",
      "Hispanic/Latino",
      "Other",
      "Asian",
      "Black",
      "White"
    )
  )) %>%
  filter(Demo_var == "race", !site %in% sites_wo_race) %>%
  select(site, Demo_var_i, Dx, Count) %>%
  distinct() %>%
  group_by(site, Demo_var_i) %>%
  summarise(total_count = sum(Count, na.rm = TRUE),
            .groups = 'drop') %>%
  group_by(site) %>%
  mutate(freq = total_count / sum(total_count, na.rm = TRUE))

race_plot <- race_sum %>%
  ggplot(aes(y = fct_relevel(site, sorted_sites), 
             x = freq, fill = fct_rev(Demo_var_i))) + 
  geom_col() +
  rcartocolor::scale_fill_carto_d(palette = 6) +
  scale_x_continuous(labels = scales::percent_format()) +
  labs(x = 'Race/ethnic group proportion', y = NULL, fill = NULL) +
  guides(fill = guide_legend(nrow = 1, reverse = TRUE)) +
  coord_cartesian(expand = FALSE) +
  theme(legend.position = "top") +
  theme(panel.grid = element_blank(),
        legend.key.height = unit(3, 'mm')) +
  NULL
```

```{r combine-plots, fig.height=7, fig.width=9}
cowplot::plot_grid(gender_plot, age_plot, race_plot, ncol = 1,
                   rel_heights = c(1, 1.1, 0.75))
```

```{r echo=T, message=FALSE, warning=FALSE, results='hide'}
neuro_types <- c('None', 'Central', 'Peripheral', 'Both')

surv_plot <- combined_table %>%
  filter(Demo_var == "survival") %>%
    mutate(Dx = gsub('n_var_', '', Dx) %>% fct_relevel(neuro_types)) %>% 
  ggplot(aes(
    x = Dx,
    y = Count,
    fill = Demo_var_i
  )) +
  # geom_violin(alpha = 0.2) +
  geom_point(color = 'white', shape = 21, size = 3) +
  scale_fill_manual(values =  c('#FFE3CB', '#E58605')) +
  facet_wrap(~ Demo_var_i, scale = "free_y", nrow = 1) +
  xlab("") +
  ylab("") +
  theme_bw() +
  theme(legend.position = "none") +
    NULL

# scales::seq_gradient_pal("white", '#CC61AF')(seq(0,1,length.out = 10))[-1]
severity_plot <- 
  combined_table %>%
  filter(Demo_var == "severity") %>%
    mutate(Dx = gsub('n_var_', '', Dx) %>% fct_relevel(neuro_types)) %>% 
  ggplot(aes(
    x = Demo_var_i,
    y = Count,
    fill = Demo_var_i
  )) +
  # geom_violin(alpha = 0.2) +
  geom_point(color = 'white', shape = 21, size = 3) +
  scale_fill_manual(values = c('#F6DCED', '#CC61AF')) +
  facet_wrap(~ Dx, scale = "free_y", nrow = 1) +
  xlab("") +
  ylab("") +
  theme_bw() +
  theme(legend.position = "none") +
    NULL

readmit_plot <- ggplot(combined_table %>%
         filter(Demo_var == "readmitted") %>% 
         filter(!Dx == "None"), 
       aes(x = site, y = Count, group = site,
                           fill = site)) + 
  geom_bar(stat="identity", position = "dodge") + 
  #coord_flip() +
   scale_fill_viridis_d() + 
  #rcartocolor::scale_fill_carto_d() +
  facet_grid(Dx~Demo_var_i, scale = "free_y") + 
  #facet_wrap(~Dx, nrow = 1) + 
  xlab("") + 
  ylab("") + 
  theme_bw() + 
  theme(legend.position = "none",
        axis.text.x = element_text(size = 8, angle = 45, hjust = 1)) 

# Create legend
legend_b <- get_legend(
  race_plot + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "top",
          legend.title = element_blank())
)
```

```{r}
combined_table %>% 
  filter(Demo_var_i == 'Alive') %>% 
  select(site, starts_with('prop')) %>% 
  distinct() %>% 
  pivot_longer(- site) %>% 
  mutate(name = gsub('prop_', '', name) %>% fct_relevel(neuro_types)) %>% 
  ggplot(aes(x = name, y = value, group = site, color = site)) +
    geom_point() +
  geom_line() +
  scale_y_continuous(limits = c(0,1)) +
  labs(x = NULL, y = 'Proportion survived') +
  NULL

combined_table %>% 
  filter(Demo_var_i == 'Alive') %>% 
  select(site, starts_with('prop')) %>% 
  distinct() %>% 
  pivot_longer(- site) %>% 
  mutate(name = gsub('prop_', '', name) %>% fct_relevel(neuro_types)) %>% 
  ggplot(aes(x = name, y = value)) +
  geom_boxplot() +
    geom_point() +
  scale_y_continuous(limits = c(0,1)) +
  labs(x = NULL, y = 'Proportion survived') +
  NULL

combined_table %>% 
  filter(Demo_var_i == 'Severe') %>% 
  select(site, starts_with('prop')) %>% 
  distinct() %>% 
  pivot_longer(- site) %>% 
  mutate(name = gsub('prop_', '', name) %>% fct_relevel(neuro_types)) %>%
  ggplot(aes(x = name, y = value)) +
  geom_boxplot() +
    geom_point() +
  scale_y_continuous(limits = c(0,1)) +
  labs(x = NULL, y = 'Proportion severe') +
  NULL
```

point size = count?

```{r message=FALSE, warning=FALSE, fig.width=10}
# Arrange plots
# p1 <- plot_grid(sex_plot, age_plot, labels=c("A", "B"), ncol = 2, nrow = 1)
# p2 <- plot_grid(race_plot, labels = c("C"), ncol = 1)
plot_grid(severity_plot, surv_plot, labels = c("E", "F"), ncol = 2, nrow = 1)
```
