---
title: "demo_figure"
author: "Meg Hutch"
date: "3/22/2021"
output: html_document
---

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(gridGraphics)
library(gridExtra)
library(ggpubr)
library(DT)
library(kableExtra)
library(ggplot2)
library(viridis)
library(forcats)
library(cowplot)
```

```{r}
load('results/NWU_results.rda')
load('results/UPENN_results.rda')
load('results/UPitt_results.rda')
load('results/APHP_results.rda')
load('results/FRBDX_results.rda')
```

## Demographic Data

### Pre-processing

```{r include=FALSE}
demo_table_list <- list()
results <- c("NWU_results", "UPENN_results", "UPitt_results", "APHP_results", "FRBDX_results")

for (i in results) { 
  tmp <- get(i)
  demo_table <- tmp[["first_hosp_results"]][["cpns_results"]][["demo_table"]]
  demo_table <- as.data.frame(demo_table)
  demo_table <- demo_table %>% select(site, everything())
  demo_table_list[[i]] <- demo_table
}
combined_table <- do.call(rbind.data.frame, demo_table_list)

# site level differences in variable names require tolower()
combined_table <- combined_table %>%
  mutate(variable = tolower(variable)) 
```

## Table One

```{r}
## Add total Patients
n <- combined_table %>% 
  filter(variable == "sex.female" | variable == "sex.male") %>%
  select(variable, n_var_None, n_var_Peripheral, n_var_Central, n_var_Both)

n_all <-  n %>% 
  select(-variable) %>% 
  colSums()  %>%
  t() %>%
  as.data.frame() %>%
  mutate(variable = "All Patients")

## Gender
n_female <- n %>% 
  filter(variable == "sex.female") %>% 
  select(-variable) %>% 
  colSums()  %>%
  t() %>%
  as.data.frame() %>%
  mutate(variable = "female")

n_male <- n %>% 
  filter(variable == "sex.male") %>% 
  select(-variable) %>% 
  colSums() %>% 
  t() %>%
  as.data.frame() %>%
  mutate(variable = "male")

## Age
age_vars <- combined_table %>% 
  filter(stringr::str_detect(variable, 'age')) %>%
  distinct(variable) %>%
  arrange(variable)

age_sums_list <- list()

for (i in age_vars$variable) {
  table_age_sums <- combined_table %>%
    filter(variable == paste(i)) %>%
    select(n_var_None, n_var_Peripheral, n_var_Central, n_var_Both) %>%
    colSums(na.rm = TRUE) %>%
    t() %>%
    as.data.frame() %>%
    mutate(variable = paste(i))
  age_sums_list[[i]] <- table_age_sums
}
n_age <- do.call(rbind.data.frame, age_sums_list)

## Race
race_vars <- combined_table %>% 
  filter(stringr::str_detect(variable, 'race')) %>%
  arrange(site) %>%
  distinct(variable) 

race_sums_list <- list()

for (i in race_vars$variable) {
  table_race_sums <- combined_table %>%
    filter(variable == paste(i)) %>%
    select(n_var_None, n_var_Peripheral, n_var_Central, n_var_Both) %>%
    colSums(na.rm = TRUE) %>%
    t() %>%
    as.data.frame() %>%
    mutate(variable = paste(i))
  race_sums_list[[i]] <- table_race_sums
}
n_race <- do.call(rbind.data.frame, race_sums_list)

## Readmitted
readmit_vars <- combined_table %>% 
  filter(stringr::str_detect(variable, 'readmitted')) %>%
  distinct(variable) 

readmit_sums_list <- list()

for (i in readmit_vars$variable) {
  table_readmit_sums <- combined_table %>%
    filter(variable == paste(i)) %>%
    select(n_var_None, n_var_Peripheral, n_var_Central, n_var_Both) %>%
    colSums(na.rm = TRUE) %>%
    t() %>%
    as.data.frame() %>%
    mutate(variable = paste(i))
  readmit_sums_list[[i]] <- table_readmit_sums
}
n_readmit <- do.call(rbind.data.frame, readmit_sums_list)

## Death
death_vars <- combined_table %>% 
  filter(stringr::str_detect(variable, 'survival')) %>%
  distinct(variable) 

death_sums_list <- list()

for (i in death_vars$variable) {
  table_death_sums <- combined_table %>%
    filter(variable == paste(i)) %>%
    select(n_var_None, n_var_Peripheral, n_var_Central, n_var_Both) %>%
    colSums(na.rm = TRUE)  %>%
    t() %>%
    as.data.frame() %>%
    mutate(variable = paste(i))
  death_sums_list[[i]] <- table_death_sums
}
n_death <- do.call(rbind.data.frame, death_sums_list)

tableOne_compiled <- rbind(n_all, 
                           n_female, 
                           n_male,
                           n_age,
                           n_race,
                           n_readmit,
                           n_death) %>%
  rename("Table 1" = variable,
         "None" = n_var_None,
         "PNS" = n_var_Peripheral,
         "CNS" = n_var_Central,
         "Both" = n_var_Both)

dx_vars = c("None", "PNS", "CNS", "Both")
n_list = list()
for(i in (dx_vars)) {
  n_sample <- tableOne_compiled %>%
  filter(`Table 1` == "All Patients") %>%
  select(i)
  n_list[[i]] <- n_sample
}
n_list <- do.call(cbind.data.frame, n_list)

tableOne_compiled <- tableOne_compiled %>%
  mutate(N = rowSums(across(where(is.numeric))),
         None_perc = round(None/n_list$None*100, 1),
         PNS_perc = round(PNS/n_list$PNS*100, 1),
         CNS_perc = round(CNS/n_list$CNS*100, 1),
         Both_perc = round(Both/n_list$Both*100, 1),
         None = paste(None, "(", None_perc, "%", ")"),
         PNS = paste(PNS, "(", PNS_perc, "%", ")"),
         CNS = paste(CNS, "(", CNS_perc, "%", ")"),
         Both = paste(Both, "(", Both_perc, "%", ")")) %>%
  select(`Table 1`, N, None, CNS, PNS, Both, -None_perc, -PNS_perc, -CNS_perc, -Both_perc) 

rownames(tableOne_compiled) <- NULL

# recode names of variables
tableOne_compiled$`Table 1` <-  recode(tableOne_compiled$`Table 1`,
                                         female = "Female",
                                         male = "Male",
                                         age_group.00to02  = "0-2",
                                         age_group.03to05 = "3-5",
                                         age_group.06to11 = "6-11",
                                         age_group.12to17 = "12-17",
                                         age_group.18to25 = "18-25",
                                         age_group.26to49 = "26-49",
                                         age_group.50to69 = "50-69",
                                         age_group.70to79 = "70-79",
                                         age_group.80plus = "80+",
                                         race.white = "White",
                                         race.american_indian = "American Indian",
                                         race.asian = "Asian",
                                         race.black = "Black",
                                         race.hawaiian_pacific_islander = "Hawaiian/Pacific Islander",
                                         race.hispanic_latino = "Hispanic/Latino",
                                         race.other = "Other",
                                         readmitted.false = "Not Readmitted",
                                         readmitted.true = "Readmitted",
                                         survival.alive = "Alive",
                                         survival.deceased = "Deceased")


kbl(tableOne_compiled) %>%
  add_header_above(c(" ", "", "No Neurological Disease" = 1, "Neurological Disease" = 3)) %>%
  kable_paper("striped", full_width = F) %>%
  pack_rows("Age", 4, 12) %>%
  pack_rows("Race & Ethnicty", 13, 19) %>%
  pack_rows("Readmission", 20, 21) %>%
  pack_rows("Deceased", 22, 23)
```

```{r fig.height=15, fig.width=11}
combined_table <- combined_table %>%
    mutate(Demo_var = sub("\\..*", "", variable),
           Demo_var_i = sub(".*\\.", "", variable)) %>%
  pivot_longer(cols = c(n_var_None:n_var_Both),
               names_to = "Dx",
               values_to = "Count")

combined_table$Dx <- recode(combined_table$Dx,
                            n_var_Both = "Both",
                            n_var_Central = "CNS",
                            n_var_Peripheral = "PNS",
                            n_var_None = "None")

combined_table$Dx <- fct_relevel(combined_table$Dx, 
                                         c('None', 'CNS', 'PNS', "Both"))
```

```{r}
combined_table$Demo_var_i <-  recode(combined_table$Demo_var_i,
                                     female = "Female",
                                     male = "Male",
                                     `00to02`  = "0-2",
                                     `03to05` = "3-5",
                                     `06to11` = "6-11",
                                     `12to17` = "12-17",
                                     `18to25` = "18-25",
                                     `26to49` = "26-49",
                                     `50to69` = "50-69",
                                     `70to79` = "70-79",
                                     `80plus` = "80+",
                                     white = "White",
                                     american_indian = "American Indian",
                                     asian = "Asian",
                                     black = "Black",
                                     hawaiian_pacific_islander = "Hawaiian/Pacific Islander",
                                     hispanic_latino = "Hispanic/Latino",
                                     other = "Other",
                                     false = "Not Readmitted",
                                     true = "Readmitted",
                                     alive = "Alive",
                                     deceased = "Deceased",
                                     `non-severe` = "Non-Severe",
                                     severe = 'severe')
```

## Figures

```{r echo=T, message=FALSE, warning=FALSE, results='hide'}
race_dx <- combined_table %>% 
  filter(Demo_var == "race") %>%
  mutate(Demo_var_i = as.factor(Demo_var_i))

race_plot <- ggplot(race_dx %>%
         mutate(Demo_var_i = fct_relevel(Demo_var_i,
                                         c("Hawaiian/Pacific Islander", 
                                           "American Indian",
                                           "Hispanic/Latino",
                                           "Other", 
                                           "Asian", 
                                           "Black", 
                                           "White"))),
        aes(x = Demo_var_i, y = Count, group = site,
                           fill = site)) + 
  geom_bar(stat="identity", position = "dodge") + 
  coord_flip() +
  scale_fill_viridis_d() + 
  #rcartocolor::scale_fill_carto_d() +
  facet_wrap(~Dx, nrow = 1, scale = "free_x")  + 
  xlab("") + 
  ylab("") + 
  theme_bw() + 
  theme(legend.position = "none",
        legend.title = element_text()) 

age_dx <- combined_table %>% 
  filter(Demo_var == "age_group") %>%
  mutate(Demo_var_i = as.factor(Demo_var_i))

age_plot <- ggplot(age_dx %>%
         filter(Demo_var == "age_group") %>%
         mutate(Demo_var_i = fct_relevel(Demo_var_i,
                                         c("0-2",
                                           "3-5",
                                           "6-11",
                                           "12-17",
                                           "18-25",
                                           "26-49",
                                           "50-69",
                                           "70-79",
                                           "80+"))),
               aes(x = Demo_var_i, y = Count, group = site,
                           fill = site)) + 
  geom_bar(stat="identity", position = "dodge") + 
  coord_flip() +
  scale_fill_viridis_d() + 
  #rcartocolor::scale_fill_carto_d() +
  facet_wrap(~Dx, nrow = 1, scale = "free_x") + 
  xlab("") + 
  ylab("") + 
  theme_bw() + 
  theme(legend.position = "none") 

sex_plot <- ggplot(combined_table %>%
         filter(Demo_var == "sex"), 
               aes(x = site, y = Count, group = site,
                           fill = site)) + 
  geom_bar(stat="identity", position = "dodge") + 
  #coord_flip() +
  scale_fill_viridis_d() + 
  #rcartocolor::scale_fill_carto_d() +
  #facet_wrap(~Dx, nrow = 1, scale = "fixed") + 
  facet_grid(Dx~Demo_var_i, scale = "free_y") + 
  xlab("") + 
  ylab("") + 
  theme_bw() + 
  theme(legend.position = "none", 
        axis.text.x = element_text(size = 8, angle = 45, hjust = 1)) 

surv_plot <- ggplot(combined_table %>%
         filter(Demo_var == "survival"), 
              aes(x = site, y = Count, group = site,
                           fill = site)) + 
  geom_bar(stat="identity", position = "dodge") + 
  #coord_flip() +
  #rcartocolor::scale_fill_carto_d() +
  scale_fill_viridis_d() + 
  facet_grid(Dx~Demo_var_i, scale = "free_y") + 
  xlab("") + 
  ylab("") + 
  theme_bw() + 
  theme(legend.position = "none",
        axis.text.x = element_text(size = 8, angle = 45, hjust = 1)) 

severity_plot <- ggplot(combined_table %>%
         filter(Demo_var == "severity"), 
               aes(x = site, y = Count, group = site,
                           fill = site)) + 
  geom_bar(stat="identity", position = "dodge") + 
  #coord_flip() +
  #rcartocolor::scale_fill_carto_d() +
  scale_fill_viridis_d() + 
  facet_grid(Dx~Demo_var_i, scale = "free_y") + 
  xlab("") + 
  ylab("") + 
  theme_bw() + 
  theme(legend.position = "none",
        axis.text.x = element_text(size = 8, angle = 45, hjust = 1)) 

readmit_plot <- ggplot(combined_table %>%
         filter(Demo_var == "readmitted") %>% 
         filter(!Dx == "None"), 
       aes(x = site, y = Count, group = site,
                           fill = site)) + 
  geom_bar(stat="identity", position = "dodge") + 
  #coord_flip() +
   scale_fill_viridis_d() + 
  #rcartocolor::scale_fill_carto_d() +
  facet_grid(Dx~Demo_var_i, scale = "free_y") + 
  #facet_wrap(~Dx, nrow = 1) + 
  xlab("") + 
  ylab("") + 
  theme_bw() + 
  theme(legend.position = "none",
        axis.text.x = element_text(size = 8, angle = 45, hjust = 1)) 

# Create legend
legend_b <- get_legend(
  race_plot + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "top",
          legend.title = element_blank())
)
```

```{r fig.height=14, fig.width=10, message=FALSE, warning=FALSE}
# Arrange plots
p1 <- plot_grid(sex_plot, age_plot, labels=c("A", "B"), ncol = 2, nrow = 1)
p2 <- plot_grid(race_plot, labels = c("C"), ncol = 1)
p3 <- plot_grid(readmit_plot, severity_plot, surv_plot, labels = c("D", "E", "F"), ncol = 3, nrow = 1)
plot_combined <- plot_grid(legend_b, p1, p2, p3, nrow = 4, ncol = 1, rel_heights = c(0.5,2,2,2))
plot_combined
```


