---
title: "Demo Figure"
author: "Meg Hutch"
date: "3/22/2021"
output: html_document
---

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(gridGraphics)
library(gridExtra)
library(ggpubr)
library(DT)
library(kableExtra)
library(cowplot)
theme_set(theme_bw() +
            theme(panel.grid.minor = element_blank()))
```

```{r}
rdas <- list.files(path = 'results',
                   pattern = '.rda',
                   full.names = TRUE)
for (rda in rdas)
  load(rda)

rm(rdas, rda)
sorted_sites <- rev(c("APHP", "FRBDX", "HPG23", "ICSM",  
                      "MGB", "NWU", "UPENN", "UPITT"))
sites_wo_race <- c('APHP', 'FRBDX', 'ICSM', 'HPG23')
# colorBlindGrey6 <- 
#   c("#0072B2", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#CC79A7")

results <- paste(sorted_sites, 'results', sep = '_')
```

## Demographic Data

### Pre-processing

```{r}
demo_table_list <- list()

for (i in results) { 
  tmp <- get(i)
  demo_table_list[[i]] <- tmp[[c("first_hosp_results",
                                 "cpns_results",
                                 "demo_table")]] %>% 
    select(site, everything())
}
combined_table_wide <- bind_rows(demo_table_list) %>%
  # site level differences in variable names require tolower()
  mutate(
    site = toupper(site),
    variable = tolower(variable),
    Demo_var = sub("\\..*", "", variable),
    Demo_var_i = sub(".*\\.", "", variable) %>% 
      gsub('_', ' ', .) %>% 
      str_to_title() %>% 
      recode(
        `00to02`  = "0-2",
        `03to05` = "3-5",
        `06to11` = "6-11",
        `12to17` = "12-17",
        `18to25` = "18-25",
        `26to49` = "26-49",
        `50to69` = "50-69",
        `70to79` = "70-79",
        `80plus` = "80+",
        race.white = "White",
        race.american_indian = "American Indian",
        `Hawaiian Pacific Islander` = "Hawaiian/Pacific Islander",
        `Hispanic Latino` = "Hispanic/Latino",
        `False` = "Not Readmitted",
        `True` = "Readmitted")
  )

# heatmap(UPITT_results$elix_mat)
```

_Note_: We will probably want to examine PNS and Both later.

## Table One

```{r}
ordered_vars <- c("all", "sex", "age_group", "race", 
                  "readmitted", "severity", "survival")
tableOne_inter <- combined_table_wide %>% 
  group_by(variable, Demo_var, Demo_var_i) %>% 
  summarise(across(starts_with('n_var'), 
                   function(x) sum(x, na.rm = TRUE)))

tableOne_compiled <- tableOne_inter %>% 
  ungroup() %>% 
  filter(Demo_var == 'sex') %>% 
  summarise(across(where(is.numeric), sum)) %>% 
  data.frame(
    variable = 'all',
    Demo_var = 'all',
             Demo_var_i = 'All Patients',
             .) %>% 
  bind_rows(tableOne_inter) %>%
  mutate(N = rowSums(across(where(is.numeric))),
         Demo_var = factor(Demo_var, levels = ordered_vars)) %>% 
  group_by(Demo_var) %>% 
  mutate(across(starts_with('n_var'),
                function(x)
                    paste0(x, ' (', round(x / sum(x, na.rm = TRUE) * 100, 1), '%', ')')
                )) %>%
  ungroup() %>% 
  arrange(Demo_var) %>% 
  select(Demo_var_i, N, starts_with('n_var')) %>%
  `colnames<-`(gsub(
    x = names(.),
    pattern = "n_var_",
    replacement = ""
  )) %>% 
  rename('Table 1' = Demo_var_i)

kbl(tableOne_compiled) %>%
  add_header_above(c(
    " ",
    "",
    "No Neurological Disease" = 1,
    "Neurological Disease" = 3
  )) %>%
  kable_paper("striped", full_width = F) %>%
  pack_rows("Gender", 2, 3) %>%
  pack_rows("Age", 4, 12) %>%
  pack_rows("Race & Ethnicity", 13, 19) %>%
  pack_rows("Readmission status", 20, 21) %>%
  pack_rows("Severity status", 22, 23) %>% 
  pack_rows("Survival status", 24, 25)

```

```{r fig.height=15, fig.width=11}
combined_table <- combined_table_wide %>%
  pivot_longer(
    cols = c(n_var_None:n_var_Both),
    names_to = "Dx",
    values_to = "Count"
  ) %>%
  replace_na(list(Count = 0)) %>% 
  mutate(Dx = gsub('n_var_', '', Dx) %>% 
           fct_relevel(c('None', 'Central', 'Peripheral', "Both")))
```


## Figures

```{r echo=T, message=FALSE, warning=FALSE, results='hide'}
race_dx <- combined_table %>% 
  filter(Demo_var == "race") %>%
  mutate(Demo_var_i = as.factor(Demo_var_i))

age_dx <- combined_table %>% 
  filter(Demo_var == "age_group") %>%
  mutate(Demo_var_i = as.factor(Demo_var_i))

```

```{r gender-plot} 
showtext::showtext_auto()
female <- intToUtf8(9792)
male <- intToUtf8(9794)
gender_count <- combined_table %>%
  filter(Demo_var == "sex") %>% 
  group_by(site, Demo_var_i) %>% 
  summarise(total_count = sum(Count, na.rm = TRUE), .groups = 'drop')

gender_plot <- gender_count %>% 
  mutate(total_count = if_else(Demo_var_i == 'Male', - total_count, total_count)) %>%
  ggplot(aes(y = fct_relevel(site, sorted_sites), 
             x = total_count, color = Demo_var_i)) +
  geom_col(position = 'identity', fill = 'grey70') +
  scale_color_manual(values = c('white', 'white')) +
  scale_x_continuous(breaks = c(-10000, -5000, -2000, 0, 2000, 5000),
                     labels = c(10000, 5000, 2000, 0, 2000, 5000),
                     trans = ggallin::ssqrt_trans) +
  geom_vline(xintercept = 0, color = 'white') +
  geom_text(data = . %>% filter(Demo_var_i == 'Male'),
            aes(y = site, x = total_count - 22*sqrt(abs(total_count)),
                label = abs(total_count)), color = 'grey10', size = 3) +
  geom_text(data = . %>% filter(Demo_var_i == 'Female'),
            aes(y = site, x = total_count + 19*sqrt(abs(total_count)),
                label = abs(total_count)), color = 'grey10', size = 3) +
  geom_text(data = . %>% filter(site == 'APHP', Demo_var_i == 'Female'),
            aes(y = length(sorted_sites), x = total_count - 600), fontface = 2,
            label = female, size = 3, color = 'white') +
  geom_text(data = . %>% filter(site == 'APHP', Demo_var_i == 'Male'),
            aes(y = length(sorted_sites), x = total_count + 600), fontface = 2,
            label = male, size = 3, color = 'white') +
  labs(y = NULL, 
       x = 'Number of male/female patients per site', 
       fill = NULL) +
  theme(legend.position = 'None',
        # plot.margin = margin(15, 5.5, 15.5, 55.5),
        axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.spacing.y = unit(0, 'pt'),
        strip.background = element_blank(),
        strip.placement = 'inside',
        legend.background = element_blank(),
        legend.key.height = unit(1, 'line'),
        legend.title = element_text(hjust = 0, size = 9)) +
  NULL
```

```{r age-plot}
age_sum <- age_dx %>%
  filter(Demo_var == "age_group") %>%
  mutate(Demo_var_i = fct_relevel(
    Demo_var_i,
    c(
      "0-2",
      "3-5",
      "6-11",
      "12-17",
      "18-25",
      "26-49",
      "50-69",
      "70-79",
      "80+"
    )
  )) %>%
  select(site, Demo_var_i, Dx, Count) %>%
  distinct() %>%
  group_by(site, Demo_var_i) %>%
  summarise(total_count = sum(Count, na.rm = TRUE),
            .groups = 'drop') %>%
  group_by(site) %>%
  mutate(freq = total_count / sum(total_count, na.rm = TRUE))

cc <- scales::seq_gradient_pal("white", "#25796C")(seq(0,1,length.out = 10))[-1]

age_plot <- age_sum %>% 
 ggplot(aes(y = fct_relevel(site, sorted_sites), 
            x = freq, fill = fct_rev(Demo_var_i))) + 
  geom_col() +
  # scale_fill_viridis_d(direction = -1, option = 'D') + 
  scale_fill_manual(values = cc) +
  scale_x_continuous(labels = scales::percent_format()) +
  labs(x = 'Age group proportion', y = NULL, fill = NULL) +
  guides(fill = guide_legend(nrow = 1, reverse = TRUE)) +
  coord_cartesian(expand = FALSE) +
  theme(legend.position = "top") +
  theme(panel.grid = element_blank(),
        legend.key.height = unit(3, 'mm')) +
  NULL
```


```{r race-plot}
race_sum <- race_dx %>%
  mutate(Demo_var_i = fct_relevel(
    Demo_var_i,
    c(
      "Hawaiian/Pacific Islander",
      "American Indian",
      "Hispanic/Latino",
      "Other",
      "Asian",
      "Black",
      "White"
    )
  )) %>%
  filter(Demo_var == "race", !site %in% sites_wo_race) %>%
  select(site, Demo_var_i, Dx, Count) %>%
  distinct() %>%
  group_by(site, Demo_var_i) %>%
  summarise(total_count = sum(Count, na.rm = TRUE),
            .groups = 'drop') %>%
  group_by(site) %>%
  mutate(freq = total_count / sum(total_count, na.rm = TRUE))

race_plot <- race_sum %>%
  ggplot(aes(y = fct_relevel(site, sorted_sites), 
             x = freq, fill = fct_rev(Demo_var_i))) + 
  geom_col() +
  rcartocolor::scale_fill_carto_d(palette = 6) +
  scale_x_continuous(labels = scales::percent_format()) +
  labs(x = 'Race/ethnic group proportion', y = NULL, fill = NULL) +
  guides(fill = guide_legend(nrow = 1, reverse = TRUE)) +
  coord_cartesian(expand = FALSE) +
  theme(legend.position = "top") +
  theme(panel.grid = element_blank(),
        legend.key.height = unit(3, 'mm')) +
  NULL
```

```{r combine-plots, fig.height=7, fig.width=9}
cowplot::plot_grid(gender_plot, age_plot, race_plot, ncol = 1,
                   rel_heights = c(1, 1.1, 0.75))
```


## Other exploratory analyses

```{r echo=T, message=FALSE, warning=FALSE, results='hide'}
neuro_types <- c('None', 'Central', 'Peripheral', 'Both')

surv_plot <- combined_table %>%
  filter(Demo_var == "survival") %>%
    mutate(Dx = gsub('n_var_', '', Dx) %>% fct_relevel(neuro_types)) %>% 
  ggplot(aes(
    x = Dx,
    y = Count,
    fill = Demo_var_i
  )) +
  # geom_violin(alpha = 0.2) +
  geom_point(color = 'white', shape = 21, size = 3) +
  scale_fill_manual(values =  c('#FFE3CB', '#E58605')) +
  facet_wrap(~ Demo_var_i, scale = "free_y", nrow = 1) +
  xlab("") +
  ylab("") +
  theme_bw() +
  theme(legend.position = "none") +
    NULL

# scales::seq_gradient_pal("white", '#CC61AF')(seq(0,1,length.out = 10))[-1]
severity_plot <- 
  combined_table %>%
  filter(Demo_var == "severity") %>%
    mutate(Dx = gsub('n_var_', '', Dx) %>% fct_relevel(neuro_types)) %>% 
  ggplot(aes(
    x = Demo_var_i,
    y = Count,
    fill = Demo_var_i
  )) +
  # geom_violin(alpha = 0.2) +
  geom_point(color = 'white', shape = 21, size = 3) +
  scale_fill_manual(values = c('#F6DCED', '#CC61AF')) +
  facet_wrap(~ Dx, scale = "free_y", nrow = 1) +
  xlab("") +
  ylab("") +
  theme_bw() +
  theme(legend.position = "none") +
    NULL

readmit_plot <- ggplot(combined_table %>%
         filter(Demo_var == "readmitted") %>% 
         filter(!Dx == "None"), 
       aes(x = site, y = Count, group = site,
                           fill = site)) + 
  geom_bar(stat="identity", position = "dodge") + 
  #coord_flip() +
   scale_fill_viridis_d() + 
  #rcartocolor::scale_fill_carto_d() +
  facet_grid(Dx~Demo_var_i, scale = "free_y") + 
  #facet_wrap(~Dx, nrow = 1) + 
  xlab("") + 
  ylab("") + 
  theme_bw() + 
  theme(legend.position = "none",
        axis.text.x = element_text(size = 8, angle = 45, hjust = 1)) 

# Create legend
legend_b <- get_legend(
  race_plot + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "top",
          legend.title = element_blank())
)
```

```{r}
combined_table %>% 
  filter(Demo_var_i == 'Alive') %>% 
  select(site, starts_with('prop')) %>% 
  distinct() %>% 
  pivot_longer(- site) %>% 
  mutate(name = gsub('prop_', '', name) %>% fct_relevel(neuro_types)) %>% 
  ggplot(aes(x = name, y = value, group = site, color = site)) +
    geom_point() +
  rcartocolor::scale_color_carto_d() +
  geom_line() +
  scale_y_continuous(limits = c(0,1)) +
  labs(x = NULL, y = 'Proportion survived', color = NULL) +
  theme(legend.position = 'top') +
  NULL

combined_table %>% 
  filter(Demo_var_i == 'Alive') %>% 
  select(site, starts_with('prop')) %>% 
  distinct() %>% 
  pivot_longer(- site) %>% 
  mutate(name = gsub('prop_', '', name) %>% fct_relevel(neuro_types)) %>% 
  ggplot(aes(x = name, y = value)) +
  geom_boxplot() +
    geom_point() +
  scale_y_continuous(limits = c(0,1)) +
  labs(x = NULL, y = 'Proportion survived') +
  NULL

combined_table %>% 
  filter(Demo_var_i == 'Severe') %>% 
  select(site, starts_with('prop')) %>% 
  distinct() %>% 
  pivot_longer(- site) %>% 
  mutate(name = gsub('prop_', '', name) %>% fct_relevel(neuro_types)) %>%
  ggplot(aes(x = name, y = value)) +
  geom_boxplot() +
    geom_point() +
  scale_y_continuous(limits = c(0,1)) +
  labs(x = NULL, y = 'Proportion severe') +
  NULL
```

point size = count?

```{r message=FALSE, warning=FALSE, fig.width=10}
# Arrange plots
# p1 <- plot_grid(sex_plot, age_plot, labels=c("A", "B"), ncol = 2, nrow = 1)
# p2 <- plot_grid(race_plot, labels = c("C"), ncol = 1)
plot_grid(severity_plot, surv_plot, labels = c("E", "F"), ncol = 2, nrow = 1)
```
